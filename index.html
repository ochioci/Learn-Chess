<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>chess puzzles</title>
    <script>
      selected = 'none'
      dragX = -1
      dragY = -1
      async function getRandomPuzzle() {
        tag = document.getElementById("tagInput").value;
	color = document.getElementById("colorInput").value;
        const response = await fetch("getRandomPuzzle.php?tag=" + tag + "&color=" + color);
        const resText = await response.text();
        return resText.split("<br>")
      }

      async function init() {
        frameDelay = 10 //delay between game loop updates
        selectedStart='none' //square to move piece from
        selectedEnd='none' //square to move piece to
        board=[]
        flipBoard = false
        solutions = []
        solved = false
        puzzleData = ''
        selected = 'none'
        statusArea = document.getElementById("statusArea")
        
        //init canvas stuff

        canvas = document.querySelector("canvas")
        canvas.addEventListener("mousedown", handleMouseDown)
        canvas.addEventListener("mouseup", handleMouseUp)
        canvas.addEventListener("mousemove", handleMouseMove)
        canvas.width = (window.innerHeight * 0.8)
        canvas.height = (window.innerHeight * 0.8)
        ctx = canvas.getContext("2d");

        //on canvas
          //0,0 is top left
          //width, 0 is top right
          //0, height is bottom left
          //width, height is bottom right


        ctx.fillStyle = "lightblue";
        ctx.fillRect(0,100,40,40)
        //begin game loop (handles board gui)
        await startNewPuzzle();
        gameLoop();
      }

      async function startNewPuzzle() {
        statusArea.innerText = ''
        board = []
        //create 2d array that will represent the board
        //bottom left (aka [7][0]) should be white!
        //therefore [0][0] should be black right
        let toggle = false;
        for (let i = 0; i < 8; i++) {
          board.push([])
          for (let n = 0; n < 8; n++) {
            board[i].push([])
            board[i][n] = {"isDarkSquare": toggle, "occupier": {"type": "none", "color": "none"}}
            toggle = (toggle) ? false : true
          }
          toggle = (toggle) ? false : true
        }
        //WHEN READING 8x8 ARRAY board IN ROW MAJOR ORDER:
          // board[0][0] IS a8 (top left)
          // board[0][7] IS h8 (top right)
          // board[7][7] IS h1 (bottom right)
          // board[7][0] IS a1 (bottom left)

        //fill pieces into board
          //pawns
          for (let i = 0; i < 8; i++) {
            board[1][i].occupier = {"type": "pawn", "color": "b"}
            board[6][i].occupier = {"type": "pawn", "color": "w"}
          }

          //rooks
          board[0][0].occupier = {"type": "rook", "color": "b"}
          board[0][7].occupier = {"type": "rook", "color": "b"}
          board[7][0].occupier = {"type": "rook", "color": "w"}
          board[7][7].occupier = {"type": "rook", "color": "w"}

          //knights
          board[0][1].occupier = {"type": "knight", "color": "b"}
          board[0][6].occupier = {"type": "knight", "color": "b"}
          board[7][1].occupier = {"type": "knight", "color": "w"}
          board[7][6].occupier = {"type": "knight", "color": "w"}

          //bishops
          board[0][2].occupier = {"type": "bishop", "color": "b"}
          board[0][5].occupier = {"type": "bishop", "color": "b"}
          board[7][2].occupier = {"type": "bishop", "color": "w"}
          board[7][5].occupier = {"type": "bishop", "color": "w"}

          //queen
          board[0][3].occupier = {"type": "queen", "color": "b"}
          board[7][3].occupier = {"type": "queen", "color": "w"}

          // //king
          board[0][4].occupier = {"type": "king", "color": "b"}
          board[7][4].occupier = {"type": "king", "color": "w"}



        puzzleData = await getRandomPuzzle();
        seqToFollow = puzzleData[1].split(" ")
        console.log(seqToFollow)
        solutions = puzzleData[2].split(" ")
        console.log("solutions: ", solutions)
        chessLetters = 'abcdefgh'
        selected = 'none'
        dragX = -1
        dragY = -1
        flipBoard = (seqToFollow.length % 2 == 0) ? false : true;
        for (let i = 0; i < seqToFollow.length; i++) {

          let fromSquareRow = 8 - parseInt(seqToFollow[i].substring(1,2))
          let fromSquareCol = chessLetters.indexOf(seqToFollow[i].substring(0,1))


          let toSquareRow = 8 - parseInt(seqToFollow[i].substring(3,4))
          let toSquareCol = chessLetters.indexOf(seqToFollow[i].substring(2,3))

          console.log(seqToFollow[i], fromSquareRow, fromSquareCol)
          board[toSquareRow][toSquareCol].occupier = board[fromSquareRow][fromSquareCol].occupier
          board[fromSquareRow][fromSquareCol].occupier = {"type": "none", "color": "none"}

        }
        solved = false;
      }

      function gameLoop() {
        drawSquares() //draws the board's tiles
        drawPieces() //draws the board's pieces
        drawLabels() //draws the a-h, 1-8 labels
        drawHover() //draws a piece at the cursor as its being moved
        setTimeout(gameLoop, frameDelay)
      }

      function drawHover() {
        if (selected != 'none') {
          let ocp = board[selected.row][selected.col].occupier.type
          let pieceUnicode = ((ocp=="king")?'\u{2654}':(ocp=="queen")?'\u{2655}':(ocp=="rook")?'\u{2656}':(ocp=="bishop")?'\u{2657}':(ocp=="knight")?'\u{2658}':'\u{2659}')
          ctx.font = (canvas.width/8).toString() + "px serif"
          ctx.fillStyle = board[selected.row][selected.col].occupier.color == "w" ? "white" : "black";
          ctx.fillText(pieceUnicode, dragX, dragY)
        }

      }

      function drawLabels () {
        for (let i = 0; i < 8; i++) {
          ctx.font = (canvas.width/24).toString() + "px serif"
          ctx.fillStyle = "blue";
          let alpha = flipBoard ? "hgfedcba" : "abcdefgh"
          ctx.fillText(alpha.substring(i, i+1), ((canvas.width/8)*i) + canvas.width/12, canvas.height - (canvas.height/64))
          let num = (!flipBoard ? 7 - i : i)+1
          ctx.fillText(num.toString(), canvas.width/64, ((canvas.height/8) * (i+1)) - (canvas.height/12))
        }
      }

      function drawSquares() {
        for (let i = 0; i < 8; i++) {
          for (let n = 0; n < 8; n++) {
            ctx.fillStyle = board[i][n].isDarkSquare ? "darkgreen" : "lightgray";
            let drawX = n * (canvas.width/8)
            let drawY = i * (canvas.height / 8)
            ctx.fillRect(drawX, drawY, canvas.width/8, canvas.height/8)
          }
        }
      }

      function drawPieces() {
        if (!flipBoard) {
          for (let i = 0; i < 8; i++) {
            for (let n = 0; n < 8; n++) {
              if (board[i][n].occupier.type != "none") {
                ctx.fillStyle = board[i][n].occupier.color == "w" ? "white" : "black";
                let drawX = (n * (canvas.width/8))
                let drawY = (i * (canvas.height / 8)) + (canvas.height/8)
                let pieceUnicode = 'x'
                let ocp = board[i][n].occupier.type
                pieceUnicode = ((ocp=="king")?'\u{2654}':(ocp=="queen")?'\u{2655}':(ocp=="rook")?'\u{2656}':(ocp=="bishop")?'\u{2657}':(ocp=="knight")?'\u{2658}':'\u{2659}') //holy shit this fucking works

                ctx.font = (canvas.width/8).toString() + "px serif"
                if (selected != 'none') {
                  if (!(selected.row == i && selected.col == n)) {
                    ctx.fillText(pieceUnicode, drawX, drawY)
                  }
                } else {
                  ctx.fillText(pieceUnicode, drawX, drawY)
                }

              }
            }
          }
        } else {
          for (let i = 0; i < 8; i++) {
            for (let n = 0; n < 8; n++) {
              if (board[i][n].occupier.type != "none") {
                ctx.fillStyle = board[i][n].occupier.color == "w" ? "white" : "black";
                let drawX = ((7-n) * (canvas.width/8)) //we basically gotta flip the board horizontically and vertically to see black's pov
                let drawY = ((7-i) * (canvas.height / 8)) + (canvas.height/8)
                let pieceUnicode = 'x'
                let ocp = board[i][n].occupier.type
                pieceUnicode = ((ocp=="king")?'\u{2654}':(ocp=="queen")?'\u{2655}':(ocp=="rook")?'\u{2656}':(ocp=="bishop")?'\u{2657}':(ocp=="knight")?'\u{2658}':'\u{2659}') //holy shit this fucking works

                ctx.font = (canvas.width/8).toString() + "px serif"
                if (selected != 'none') {
                  if (!(selected.row == i && selected.col == n)) {
                    ctx.fillText(pieceUnicode, drawX, drawY)
                  }
                } else {
                  ctx.fillText(pieceUnicode, drawX, drawY)
                }
              }
            }
          }
        }

      }


      function handleMouseMove(e) {
        if (selected != 'none') {
          dragX = e.clientX - canvas.getBoundingClientRect().x
          dragY = e.clientY - canvas.getBoundingClientRect().y
          // console.log(dragX, dragY)
        }
      }

      function handleMouseDown(e) {
        let x = e.clientX - canvas.getBoundingClientRect().x
        let y = e.clientY - canvas.getBoundingClientRect().y
        // console.log('abcdefgh'.substring(Math.floor(e.clientX / (canvas.width/8))-1, Math.floor(e.clientX / (canvas.width/8)))) //selected file
        let clickedCol = Math.floor(x/ (canvas.height/8))
        let clickedRow = Math.floor(y / (canvas.width/8))
        if (flipBoard) {
          clickedRow = 7 - clickedRow
          clickedCol = 7 - clickedCol
        }


        if ((flipBoard && board[clickedRow][clickedCol].occupier.color == "b") || (!flipBoard && board[clickedRow][clickedCol].occupier.color=="w")) {
          selected = {"row": clickedRow, "col": clickedCol}
          console.log(selected)
          //continue from here! add dragging and dropping pieces
        }
      }

      function handleMouseUp(e) {
        let x = e.clientX - canvas.getBoundingClientRect().x
        let y = e.clientY - canvas.getBoundingClientRect().y
        let releasedCol = Math.floor(x/ (canvas.height/8))
        let releasedRow = Math.floor(y / (canvas.width/8))
        if (flipBoard) {
          releasedRow = 7 - releasedRow
          releasedCol = 7 - releasedCol
        }
        let friendlyColor = flipBoard ? "b" : "w"; //opposing piece color based off if board is flipped
        console.log("moved from ", selected.row, selected.col, " to ", releasedRow, releasedCol)
        if (board[releasedRow][releasedCol].occupier.color != friendlyColor && selected != 'none') {
          board[releasedRow][releasedCol].occupier = board[selected.row][selected.col].occupier
          board[selected.row][selected.col].occupier = {"type": "none", "color": "none"}
          handleAnswer(selected.row, selected.col, releasedRow, releasedCol)
          selected = 'none'
        } else {
          selected = 'none'
        }
      }

      function handleAnswer(fromRow, fromCol, toRow, toCol) {
        let eFromRow = (8-fromRow).toString()
        let eToRow = (8-toRow).toString()
        let eFromCol = 'abcdefgh'.substring(fromCol, fromCol+1)
        let eToCol = 'abcdefgh'.substring(toCol, toCol+1)
        if (solutions.includes(eFromCol+eFromRow+eToCol+eToRow)) {
          statusArea.innerText = "Correct!"
        } else {
          statusArea.innerText = "Incorrect :("
        }
      }




      function printBoardRowMajor() {
        for (let i = 0; i < 8; i++) {
          let o = ''
          for (let n = 0; n < 8; n++) {
            o += "[" + board[i][n] + "]"
          }
          console.log(o)
        }
      }
      document.addEventListener("DOMContentLoaded", init)
    </script>
  </head>
  <body>
    <canvas style="margin:5vh;"></canvas>
    <div id="statusArea"></div>
    <button onclick="startNewPuzzle()">New Puzzle</button>
    <input id="tagInput" value="none" placeholder="write 'none' if no tag">
    <input id="colorInput" value="either" placeholder="w/b/either">
  </body>
</html>
